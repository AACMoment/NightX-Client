package net.aspw.nightx.features.module.modules.exploit

import net.aspw.nightx.event.EventState
import net.aspw.nightx.event.EventTarget
import net.aspw.nightx.event.MotionEvent
import net.aspw.nightx.features.module.Module
import net.aspw.nightx.features.module.ModuleCategory
import net.aspw.nightx.features.module.ModuleInfo
import net.aspw.nightx.utils.*
import net.minecraft.entity.Entity
import net.minecraft.entity.EntityLivingBase
import net.minecraft.network.play.client.C03PacketPlayer.C04PacketPlayerPosition
import java.util.function.Consumer
import javax.vecmath.Vector3d

@ModuleInfo(name = "HitTP", category = ModuleCategory.EXPLOIT)
class HitTP : Module() {
    private var targetEntity: EntityLivingBase? = null
    private var shouldHit = false

    @EventTarget
    fun onMotion(event: MotionEvent) {
        if (event.eventState !== EventState.PRE) return
        val facedEntity =
            RaycastUtils.raycastEntity(100.0) { raycastedEntity: Entity? -> raycastedEntity is EntityLivingBase }
        mc.thePlayer ?: return
        if (mc.gameSettings.keyBindAttack.isKeyDown && EntityUtils.isSelected(facedEntity, true)) {
            if (facedEntity.getDistanceSqToEntity(mc.thePlayer) >= 1.0) targetEntity = facedEntity as EntityLivingBase
        }
        if (targetEntity != null) {
            val rotationVector = RotationUtils.getVectorForRotation(Rotation(mc.thePlayer.rotationYaw, 0f))
            val x = mc.thePlayer.posX + rotationVector.xCoord * (mc.thePlayer.getDistanceToEntity(targetEntity))
            val z = mc.thePlayer.posZ + rotationVector.zCoord * (mc.thePlayer.getDistanceToEntity(targetEntity))
            val y = targetEntity!!.position.y + 0.0
            PathUtils.findPath(x, y, z, 3.0).forEach(Consumer { pos: Vector3d ->
                mc.netHandler.addToSendQueue(
                    C04PacketPlayerPosition(
                        pos.getX(),
                        pos.getY(),
                        pos.getZ(),
                        true
                    )
                )
            })
            mc.thePlayer.setPosition(x, y, z)
            shouldHit = false
            targetEntity = null
        } else shouldHit = false
    }
}